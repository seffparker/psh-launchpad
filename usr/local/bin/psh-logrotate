#!/bin/bash

## Script to compress old psh_session logs and remove the original file
## Author: Seff P.
## Version: 20200409

source /etc/psh/default.conf

LOGIN_LOG_COUNT=$(wc -l ${LOGIN_LOG} | cut -d' ' -f1)

if [ $LOGIN_LOG_COUNT -ge ${LOGIN_RECORDS} ]
        then
        echo "Rotating login log"
        tar -czPf ${LOGIN_LOG}-$(date +%F).tar.gz --remove-files ${LOGIN_LOG}
fi

echo "INFO: Compressing $COMPRESS_DAYS days old logs"
find ${SESSION_LOG_PATH} -type f -mtime +${COMPRESS_DAYS} ! -name "*.gz" | xargs -i tar -czvPf {}.tar.gz --remove-files {}
echo "INFO: Compressing old logs completed"

echo "INFO: Deleting $DELETE_DAYS days old logs"
find ${SESSION_LOG_PATH} -type f -mtime +${DELETE_DAYS} -name "*.gz" -delete -print
echo "INFO: Deleting old logs completed"
